# Interpretation of NWP model output - RCode
This repository contains R code that I used for the data analysis part of my master's thesis which was about the interpretation of point forecasts as state-dependent functionals following the work of Patrick Schmidt (Interpretation of point forecasts with unknown directive, 2019).


## Preliminaries
* R and R Studio installed
* R Packages used
    * tidyverse
    * PointFore
    * RMPI
    * snow
    * car
    * maptools
    * map
    * ggmap
    + ggplot2
* Python
* Python packages used
   * cdsapi
   * numpy
   * pandas
   * os 
   * sys 
   * datetime
   * netCDF4
   * rpy2
   * multiprocessign
* cdo for merging netCDF files

## Data
The data used had the formate .Rdata, i.e., a dataframe in R, which contained the data column-wise. Specifically, each file contained 24h-ahead precipitation forecasts for 4019 days and corresponding TRMM observations for one location. There were in total 576 000 files that covered the globe in a 0.25 times 0.25 degree grid from -50 to 50 degrees of latitude.
Additionally, a file with meta-information was used that contained for each coordinate a boolean indicating if it is over land or ocean, a region and subregion.

For further analysis, instead of the TRMM observations, the ECMWF ERA5 reanalysis data was used downloaded from https://cds.climate.copernicus.eu/#!/home in form of netCDF files. To bring them in the same form as described above, see the functions DL-CDS.py, CalculateDailyTP.py, CombineHRES_OBS_Precip.py. 

## Functions

### Data

#### DL-CDS.py
Downloads hourly precipitation data for the selected years from https://cds.climate.copernicus.eu/#!/home.
In the cdsapi.Client() function, enter the key from you user profile.

#### CalculateDailyTP.py
Hourly precipitation is summed up to daily total precipitation for a selected netCDF dowloaded with DL-CDS.py and save in an output file. All the output files can easily be merged using cdo so that we get one file with daily total precipitation as variable for all year being used es input in CombineHRES_OBS_Precip.py.

#### CombineHRES_OBS_Precip.py
Takes one file with daily total precipitation as generated by CalculatyDailyTP.py and cdo and forecasts in seperate netCDF files for each month. Combines the data for each coordinate and saves it in a single .Rdata file so that EstimaeFunctionalParallel can be used.

### Computations

#### EstimateFunctionalParallel.R
Goes through all the data files applying the functions EstimateQuantiles and EstimateExpectiles to each file.

#### EstimateQuantiles.R / EstimateExpectiles.R
Given a file name of an .Rdata file as described above, these functions apply the function EstimateFunction from the package PointFore to that file and save the output in a new .Rdata file.

#### ExtractResultsAll.R
Goes through all the result files generated by EstimateQuantiles and EstimateExpectiles and applies GetResultsQuantiles and GetResultsExpectiles to each file such that the results can be put together and saved in one data frame for quantiles and expectiles, respectively.

#### GetResultsQuantiles.R / GetResultsExpectiles.R
Load a result file for quantiles and expectiles, respectively given a vector of coordinates and return a row vector of all important results such as values for theta1, theta2, the p-value of the J-test, the mean state and the 90 percentile of the state vector. Note: The p-value of the Wald-test is extracted separately in ExtractPWald.

#### ExtractPWald.R
Analogously to ExtractResultsAll. Applies GetPWaldQuantiles and GetPWaldExpectiles.

#### MeanResults.R
Averages all results i.e. values for theta1, theta2, p-values and states over 16 coordinates, respectively (i.e. a 4 times 4 grid) merging the results of 16 points into one.

### Plots

#### WorldPlotsQuantiles.R / WorldPlotsExpectiles.R
Plots the results generated by MeanResults for quantiles and expectiles into a map and saves the plots as pdf.
